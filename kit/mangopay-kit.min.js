!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.mangoPay=t()}(this,function(){"use strict";var e={cardRegistration:{baseURL:"https://api.sandbox.mangopay.com",clientId:"",init:function(e){this._cardRegisterData=e},registerCard:function(t,r,a){if(!e.browser.corsSupport())return void a({ResultCode:"009999",ResultMessage:"Browser does not support making cross-origin Ajax calls"});var s=e.cardRegistration._validateCardData(t);return s!==!0?void a(s):void e.cardRegistration._tokenizeCard(t,e.cardRegistration._finishRegistration,r,a)},_validateCardData:function(t){var r=e._validation._cardNumberValidator._validate(t.cardNumber);if(r!==!0)return r;var a=e._validation._expirationDateValidator._validate(t.cardExpirationDate,new Date);if(a!==!0)return a;var s=e._validation._cvvValidator._validate(t.cardCvx,t.cardType);return s!==!0?s:!0},_tokenizeCard:function(t,r,a,s){e._networking._ajax({type:"post",url:this._cardRegisterData.cardRegistrationURL,crossDomain:!0,data:{data:this._cardRegisterData.preregistrationData,accessKeyRef:this._cardRegisterData.accessKey,cardNumber:t.cardNumber,cardExpirationDate:t.cardExpirationDate,cardCvx:t.cardCvx},success:function(t,i){var n="";return null!==t&&0===t.indexOf("errorCode=")?void s({xmlhttp:i,ResultCode:t.replace("errorCode=",""),ResultMessage:"Token processing error"}):null===t?void s({xmlhttp:i,ResultCode:"001599",ResultMessage:"Token processing error"}):(n={Id:e.cardRegistration._cardRegisterData.Id,RegistrationData:t},void r(n,a,s))},error:function(e,t){return t?s(t):"0"==e.status?void s({xmlhttp:e,ResultCode:"001596",ResultMessage:"An HTTP request was blocked by the User's antivirus"}):void s({xmlhttp:e,ResultCode:"001599",ResultMessage:"Token processing error"})}})},_finishRegistration:function(t,r,a){e._networking._ajax({type:"post",crossDomain:!0,url:e.cardRegistration.baseURL+"/v2.01/"+e.cardRegistration.clientId+"/CardRegistrations/"+t.Id,data:t,success:function(e,t){try{e=JSON.parse(e)}catch(s){return void a({xmlhttp:t,ResultCode:"101699",ResultMessage:"CardRegistration should return a valid JSON response"})}"000000"===e.ResultCode?r(e):a(e)},error:function(e,t){if(t)return a(t);var r="CardRegistration error";if(e.response)try{var s=JSON.parse(e.response);s.Message&&(r=s.Message)}catch(i){}a({xmlhttp:e,ResultCode:"101699",ResultMessage:r})}})}},_validation:{_cvvValidator:{_validate:function(t,r){if("MAESTRO"===r||"BCMC"===r)return!0;if(t=t?t.trim():"",r=r?r.trim():"",e._validation._helpers._validateNumericOnly(t)===!0){if("AMEX"===r&&(3===t.length||4===t.length))return!0;if("CB_VISA_MASTERCARD"===r&&3===t.length)return!0}return{ResultCode:"105204",ResultMessage:"CVV_FORMAT_ERROR"}}},_expirationDateValidator:{_validate:function(e,t){if(e=e?e.trim():"",4===e.length){var r=parseInt(e.substr(2,2),10)+2e3,a=parseInt(e.substr(0,2),10);if(a>0&&12>=a){var s=t.getFullYear();if(r>s)return!0;if(s===r){var i=t.getMonth()+1;if(a>=i)return!0}return{ResultCode:"105203",ResultMessage:"PAST_EXPIRY_DATE_ERROR"}}}return{ResultCode:"105203",ResultMessage:"EXPIRY_DATE_FORMAT_ERROR"}}},_cardNumberValidator:{_validate:function(t){return t=t?t.trim():"",e._validation._helpers._validateNumericOnly(t)===!1?{ResultCode:"105202",ResultMessage:"CARD_NUMBER_FORMAT_ERROR"}:this._validateCheckDigit(t)===!1?{ResultCode:"105202",ResultMessage:"CARD_NUMBER_FORMAT_ERROR"}:!0},_validateCheckDigit:function(e){for(var t=0,r=0,a=!1,s=e.replace(/\D/g,""),i=s.length-1;i>=0;i--){var n=s.charAt(i),r=parseInt(n,10);a&&(r*=2)>9&&(r-=9),t+=r,a=!a}return t%10===0}},_helpers:{_validateNumericOnly:function(e){var t=/^[0-9]+$/;return e.match(t)?!0:!1}}},_networking:{_ajax:function(e){function t(t,r){var a,s;e.crossDomain?(a="001598",s="A cross-origin HTTP request failed"):(a="001597",s="An HTTP request failed"),r&&r.message.length&&(s=s+": "+r.message),e.error(t,{ResultCode:a,ResultMessage:s,xmlhttp:t})}var r=new XMLHttpRequest,a="";for(var s in e.data)a+=(a.length>0?"&":"")+s+"="+encodeURIComponent(e.data[s]);var i=e.url;if("get"===e.type&&(i=e.url+(e.url.indexOf("?")>-1?"&":"?")+a),!e.crossDomain||"withCredentials"in r||!window.XDomainRequest){r.onreadystatechange=function(){4==r.readyState&&(/^2[0-9][0-9]$/.test(r.status)?e.success(r.responseText,r):e.error(r,r.status,r.statusText))};try{r.open(e.type,i,!0)}catch(n){return t(r,n)}"post"===e.type&&r.setRequestHeader("Content-type","application/x-www-form-urlencoded");try{r.send("post"===e.type?a:null)}catch(n){return t(r,n)}}else{xdr=new XDomainRequest,xdr.onerror=function(){e.error(xdr)},xdr.onload=function(){e.success(xdr.responseText,xdr)};try{xdr.open(e.type,i),xdr.send("post"===e.type?a:null)}catch(n){return t(xdr,n)}}}},browser:{corsSupport:function(){return"withCredentials"in new XMLHttpRequest?!0:window.XDomainRequest?!0:!1}}};return String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),e});