!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.mangoPay=t()}(this,function(){"use strict";var e={cardRegistration:{baseURL:"https://api.sandbox.mangopay.com",clientId:"",init:function(e){this._cardRegisterData=e},registerCard:function(t,r,a){if(!e.browser.corsSupport())return void a({ResultCode:"009999",ResultMessage:"Browser does not support making cross-origin Ajax calls"});var i=e.cardRegistration._validateCardData(t);return i!==!0?void a(i):void e.cardRegistration._tokenizeCard(t,e.cardRegistration._finishRegistration,r,a)},_validateCardData:function(t){var r=e._validation._cardNumberValidator._validate(t.cardNumber);if(r!==!0)return r;var a=e._validation._expirationDateValidator._validate(t.cardExpirationDate,new Date);if(a!==!0)return a;var i=e._validation._cvvValidator._validate(t.cardCvx,t.cardType);return i!==!0?i:!0},_tokenizeCard:function(t,r,a,i){e._networking._ajax({type:"post",url:this._cardRegisterData.cardRegistrationURL,crossDomain:!0,data:{data:this._cardRegisterData.preregistrationData,accessKeyRef:this._cardRegisterData.accessKey,cardNumber:t.cardNumber,cardExpirationDate:t.cardExpirationDate,cardCvx:t.cardCvx},success:function(t){var n="";return null===t?void i({ResultCode:"001599",ResultMessage:"Token processing error"}):(n={Id:e.cardRegistration._cardRegisterData.Id,RegistrationData:t},void r(n,a,i))},error:function(e){i({ResultCode:"001599",ResultMessage:"Token processing error"})}})},_finishRegistration:function(t,r,a){e._networking._ajax({type:"post",crossDomain:!0,url:e.cardRegistration.baseURL+"/v2/"+e.cardRegistration.clientId+"/CardRegistrations/"+t.Id,data:t,success:function(e){try{e=JSON.parse(e)}catch(t){return void a({ResultCode:"101699",ResultMessage:"CardRegistration should return a valid JSON response"})}"000000"===e.ResultCode?r(e):a(e)},error:function(e){var t="CardRegistration error";if(e.response)try{var r=JSON.parse(e.response);r.Message&&(t=r.Message)}catch(i){}a({ResultCode:"101699",ResultMessage:t})}})}},_validation:{_cvvValidator:{_validate:function(t,r){if("MAESTRO"===r)return!0;if(t=t?t.trim():"",r=r?r.trim():"",e._validation._helpers._validateNumericOnly(t)===!0){if("AMEX"===r&&(3===t.length||4===t.length))return!0;if("CB_VISA_MASTERCARD"===r&&3===t.length)return!0}return{ResultCode:"105204",ResultMessage:"CVV_FORMAT_ERROR"}}},_expirationDateValidator:{_validate:function(e,t){if(e=e?e.trim():"",4===e.length){var r=parseInt(e.substr(2,2),10)+2e3,a=parseInt(e.substr(0,2),10);if(a>0&&12>=a){var i=t.getFullYear();if(r>i)return!0;if(i===r){var n=t.getMonth()+1;if(a>=n)return!0}return{ResultCode:"105203",ResultMessage:"PAST_EXPIRY_DATE_ERROR"}}}return{ResultCode:"105203",ResultMessage:"EXPIRY_DATE_FORMAT_ERROR"}}},_cardNumberValidator:{_validate:function(t){return t=t?t.trim():"",e._validation._helpers._validateNumericOnly(t)===!1?{ResultCode:"105202",ResultMessage:"CARD_NUMBER_FORMAT_ERROR"}:this._validateCheckDigit(t)===!1?{ResultCode:"105202",ResultMessage:"CARD_NUMBER_FORMAT_ERROR"}:!0},_validateCheckDigit:function(e){for(var t=0,r=0,a=!1,i=e.replace(/\D/g,""),n=i.length-1;n>=0;n--){var s=i.charAt(n),r=parseInt(s,10);a&&(r*=2)>9&&(r-=9),t+=r,a=!a}return t%10===0}},_helpers:{_validateNumericOnly:function(e){var t=/^[0-9]+$/;return e.match(t)?!0:!1}}},_networking:{_ajax:function(e){var t=new XMLHttpRequest,r="";for(var a in e.data)r+=(r.length>0?"&":"")+a+"="+encodeURIComponent(e.data[a]);var i=e.url;return"get"===e.type&&(i=e.url+(e.url.indexOf("?")>-1?"&":"?")+r),!e.crossDomain||"withCredentials"in t||!window.XDomainRequest?(t.onreadystatechange=function(){4==t.readyState&&(/^2[0-9][0-9]$/.test(t.status)?e.success(t.responseText):e.error(t,t.status,t.statusText))},t.open(e.type,i,!0),"post"===e.type&&t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),void t.send("post"===e.type?r:null)):(xdr=new XDomainRequest,xdr.onerror=function(){e.error(xdr)},xdr.onload=function(){e.success(xdr.responseText)},xdr.open(e.type,i),void xdr.send("post"===e.type?r:null))}},browser:{corsSupport:function(){return"withCredentials"in new XMLHttpRequest?!0:window.XDomainRequest?!0:!1}}};return String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),e});